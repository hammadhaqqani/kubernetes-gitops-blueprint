name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-helm:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v3
        with:
          version: "v3.12.0"
      - name: Lint Charts
        run: |
          for chart in helm-charts/*/; do
            echo "Linting $chart"
            helm lint "$chart"
          done

  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate YAML syntax
        run: |
          pip install pyyaml
          python3 -c "
          import yaml, glob, sys
          errors = 0
          for pattern in ['argocd/**/*.yaml', 'kustomize/**/*.yaml', 'monitoring/**/*.yaml']:
              for f in glob.glob(pattern, recursive=True):
                  try:
                      with open(f) as fh:
                          list(yaml.safe_load_all(fh))
                      print(f'OK: {f}')
                  except Exception as e:
                      print(f'FAIL: {f}: {e}')
                      errors += 1
          sys.exit(1 if errors else 0)
          "
