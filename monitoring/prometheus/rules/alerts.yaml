apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: microservices-alerts
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: microservices.rules
      interval: 30s
      rules:
        - alert: HighCPUUsage
          expr: |
            sum(rate(container_cpu_usage_seconds_total{namespace="microservices-dev"}[5m])) by (pod) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage detected"
            description: "Pod {{ $labels.pod }} has CPU usage above 80%"

        - alert: HighMemoryUsage
          expr: |
            sum(container_memory_working_set_bytes{namespace="microservices-dev"}) by (pod) / sum(container_spec_memory_limit_bytes{namespace="microservices-dev"}) by (pod) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage detected"
            description: "Pod {{ $labels.pod }} has memory usage above 80%"

        - alert: PodCrashLooping
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace="microservices-dev"}[15m]) > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod is crash looping"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crash looping"

        - alert: PodNotReady
          expr: |
            sum by (namespace, pod) (kube_pod_status_phase{phase!~"Running|Succeeded", namespace="microservices-dev"}) > 0
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "Pod is not ready"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for more than 10 minutes"

        - alert: HighRequestLatency
          expr: |
            histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{namespace="microservices-dev"}[5m])) by (le, service)) > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High request latency"
            description: "Service {{ $labels.service }} has 99th percentile latency above 1s"

        - alert: HighErrorRate
          expr: |
            sum(rate(http_requests_total{namespace="microservices-dev", status=~"5.."}[5m])) by (service) / sum(rate(http_requests_total{namespace="microservices-dev"}[5m])) by (service) > 0.05
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High error rate"
            description: "Service {{ $labels.service }} has error rate above 5%"

        - alert: RedisConnectionFailure
          expr: |
            redis_connected_clients{namespace="microservices-dev"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Redis connection failure"
            description: "Redis in namespace microservices-dev has no connected clients"

        - alert: RedisHighMemoryUsage
          expr: |
            redis_memory_used_bytes{namespace="microservices-dev"} / redis_memory_max_bytes{namespace="microservices-dev"} > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Redis high memory usage"
            description: "Redis memory usage is above 90%"

        - alert: DeploymentReplicasMismatch
          expr: |
            kube_deployment_spec_replicas{namespace="microservices-dev"} != kube_deployment_status_replicas_available{namespace="microservices-dev"}
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Deployment replicas mismatch"
            description: "Deployment {{ $labels.deployment }} desired replicas ({{ $value }}) doesn't match available replicas"

        - alert: ServiceDown
          expr: |
            up{job="kubernetes-pods", namespace="microservices-dev"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Service is down"
            description: "Service {{ $labels.service }} in namespace {{ $labels.namespace }} is down"
